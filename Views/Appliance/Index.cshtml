@{
    ViewData["Title"] = "Dish Washer";
}

<div class="mobile-content">
    <table class="mobile-monitor">
        <tr>
            <td>
                <img id="imgStatus" src="/images/normal-appliance.png" data-normal="/images/normal-appliance.png" data-promo="/images/promo-appliance.png" alt="Dish Washer" />
            </td>
        </tr>
        <tr>
            <td class="mobile-monitor-action">
                <p>
                    <label id="lblDistance"></label>
                    <input type="hidden" id="distance" value="100">
                </p>
                <div id="slider-range-min" class="ui-slider ui-corner-all ui-slider-horizontal ui-widget ui-widget-content">
                    <div class="ui-slider-range ui-corner-all ui-widget-header ui-slider-range-min" style="width: 5.15021%;">
                    </div><span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default" style="left: 5.15021%;"></span>
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <div id="lblMessage" style="margin-top:30%;">&nbsp;</div>
                <input id="btnSend" type="button" value="Start Sending Data" />
            </td>
        </tr>
    </table>
</div>

@section Scripts{
    <script type="text/javascript">
        var urlAction = '/Appliance/SendData';
        var isSentData = false;
        var startProcess, btnText, btnBgColor;

        $(function () {
            $('#spinner').hide();
            $("#lblDistance").text('Distance to beacon: ' + $("#distance").val());
            $('#lblMessage').addClass('default-status-message').html('&nbsp;');

            $("#slider-range-min").slider({
                range: "min",
                value: 100,
                min: 100,
                max: 200,
                slide: function (event, ui) {
                    $("#lblDistance").text('Distance to beacon: ' + ui.value);
                    $("#distance").val(ui.value);
                    $("#imgStatus").attr('src', function () {
                        if (ui.value > 24) {
                            return $(this).attr('data-promo');
                        }
                        else {
                            return $(this).attr('data-normal');
                        }
                    });
                }
            });

            $('#btnSend').on('click', function (e) {
                isSentData = !isSentData;
                btnText = btnBgColor = undefined;

                if (isSentData && startProcess == undefined) {
                    $('#lblMessage').css({ 'background-color': '' }).html('&nbsp;');
                    startSendingData();
                    startProcess = setInterval(function () { startSendingData() }, 5000);
                }
                else {
                    stopSendingData();
                }
            });
        });

        function stopSendingData() {
            isSentData = false;
            if (startProcess) {
                clearInterval(startProcess);
                startProcess = undefined;
            }
            if ($) {
                $('#btnSend').attr('value', 'Start Sending Data');
                $('#lblMessage').css({ 'background-color': '' }).html('&nbsp;');
                $('#spinner').hide();
            }
        }

        function startSendingData() {
            if (startProcess && isSentData)
                return;
            isSentData = true;
            if (isSentData && $ && $("#distance").val().length > 0) {
                $('#btnSend').attr('value', (isSentData ? 'Stop Sending Data' : 'Start Sending Data'));
                var distanceVal = parseInt($("#distance").val());
                $('#spinner').show();
                $.post(urlAction, { distance: distanceVal }, function (data) {
                    isSentData = false;
                    $('#spinner').hide();
                    if (data) {
                        console.log(data);
                        if (data.toLowerCase().indexOf("completed") != -1) {
                            btnBgColor = "green";
                            btnText = "Completed Successfully";
                            stopSendingData();
                        }
                    }

                    if (btnText && btnBgColor) {
                        $('#lblMessage').css({
                            'background-color': btnBgColor,
                        }).html(btnText);
                        return;
                    }
                    else {
                        $('#lblMessage').addClass('default-status-message').html('&nbsp;');
                    }
                });
            }
        }
    </script>
}